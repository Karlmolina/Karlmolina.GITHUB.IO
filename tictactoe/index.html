<link href="https://fonts.googleapis.com/css?family=Varela+Round&display=swap" rel="stylesheet"/>
<link href="../styles.css" rel="stylesheet"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.10.2/p5.min.js"></script>
<script type="module">
    import sketchUtils from '../utils/sketchUtils.mjs';

    new p5(sketchUtils.wrapSketch(s => {
        let pointList;
        let xList = [];
        let oList = [];
        let playerOneTurn = true;

        s.setup = () => {
            s.textAlign(s.CENTER, s.CENTER);
            s.colorMode(s.HSB, 255);
            s.textFont('Varela Round');
        };

        s.updateSketch = () => {
            s.background(255);
            s.textSize(sketchUtils.minSize / 2.5);
            s.strokeWeight(sketchUtils.minSize / 40);
            pointList = [];
            const amount = 3;
            for (let i = 0; i < amount; i++) {
                for (let j = 0; j < amount; j++) {
                    pointList.push(
                        s.createVector(i / amount * s.width + 1 / 6 * s.width, j / amount * s.height + .2 * s.height)
                    );
                }
            }
        };

        s.draw = () => {
            s.background(255);
            s.line(1 / 3 * s.width, 0, 1 / 3 * s.width, s.height);
            s.line(2 / 3 * s.width, 0, 2 / 3 * s.width, s.height);
            s.line(0, 1 / 3 * s.height, s.width, 1 / 3 * s.height);
            s.line(0, 2 / 3 * s.height, s.width, 2 / 3 * s.height);

            if (!sketchUtils.isTouchDevice) {
                if (playerOneTurn) {
                    s.text('O', s.mouseX, s.mouseY);
                } else {
                    s.text('X', s.mouseX, s.mouseY);
                }
            }

            oList.forEach(i => {
                const point = pointList[i];
                s.text('O', point.x, point.y);
            });

            xList.forEach(i => {
                const point = pointList[i];
                s.text('X', point.x, point.y);
            });
        };

        function makeMove() {
            let minDist = 100000;
            let minIndex = 0;
            let finished = true;
            for (let i = 0; i < pointList.length; i++) {
                if (!xList.includes(i) && !oList.includes(i)) {
                    finished = false;
                }
                const point = pointList[i];
                const dist = point.dist(s.createVector(s.mouseX, s.mouseY));
                if (dist < minDist) {
                    minDist = dist;
                    minIndex = i;
                }
            }

            if (playerOneTurn) {
                if (!xList.includes(minIndex)) {
                    oList.push(minIndex);
                }
            } else {
                if (!oList.includes(minIndex)) {
                    xList.push(minIndex);
                }
            }

            playerOneTurn = !playerOneTurn;

            if (finished) {
                resetBoard();
            }
        }

        s.mousePressed = () => {
            if (!sketchUtils.isTouchDevice) {
                makeMove();
            }
        };

        s.touchStarted = () => {
            makeMove();
        };

        function resetBoard() {
            oList = [];
            xList = [];
        }

        s.keyPressed = () => {
            resetBoard();
        };
    }));
</script>

<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
